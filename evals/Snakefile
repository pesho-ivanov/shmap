from snakemake.utils import min_version
min_version("6.15")

shell.executable("/bin/bash")  # Ensure shell compatibility
print_shellcmds = True

import os

config = {
    # Directories
    "outdir": "snake_out",
    "ref_dir": "refs",
    "reads_dir": "reads",
    
    # Reference settings
    "refname": "chm13-chr1",

    # Read simulation parameters
    "readsim_refname": "chm13-chr1",
    "accuracy": "?",
    "depth": 0.2,
    "meanlen": "?",
    
    # Mapping parameters
    "k": 25,
    "r": 0.01,
    "t": 0.4,
    
    # Tools and paths
    "time_cmd": "/usr/bin/time -f '%U\t%M'",
    "paftools": "ext/paftools.js",
    
    # Tool executables
    "tool_bin": {
        "shmap": "~/work/shmap/release/shmap",
        "minimap": "~/libs/minimap2/minimap2",
        "mm2": "~/libs/mm2-fast/minimap2",
        "blend": "~/libs/blend/bin/blend",
        "mapquik": "~/libs/mapquik/target/release/mapquik",
        "meryl": "~/libs/Winnowmap/bin/meryl",
        "winnowmap": "~/libs/Winnowmap/bin/winnowmap", 
        "mashmap3": "~/libs/MashMap/build/bin/mashmap",
    },

    # Add these to the config section
    "pbsim3": "~/libs/pbsim3/src/pbsim",
#    "seqkit": "~/miniconda3/bin/seqkit",
    "stream_lift_fasta": "stream_fasta.py",
    "chain_file": "refs/hg002v1.1_to_CHM13v2.0.chain",
#    "seqtk": "~/miniconda3/bin/seqtk",
    "hg002": {
        "fq": "reads/HG002.fq",
        "fa": "reads/HG002.fa",
        "url": "https://s3-us-west-2.amazonaws.com/human-pangenomics/T2T/scratch/HG002/sequencing/hifirevio/m84005_220827_014912_s1.hifi_reads.fastq.gz"
    }
}

best_shmap_params = "k25-r0.01-t0.4-d0.075-o0.3-mJaccard"
robustness_config = {
    "variations": { 
        "k": [15, 17, 19, 21, 23, 25, 27, 29, 31, 33, 35],
#        "r": [0.005, 0.01, 0.015, 0.02],
#        "t": [0.2, 0.3, 0.4, 0.5],
#        "d": [0.05, 0.075, 0.1, 0.15],
#        "o": [0.0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0],
#        "m": ["Jaccard", "Hamming", "Levenshtein"],
    },
}

#eval_shmap_on_datasets:
#	make eval_shmap ALLOUT_DIR=$(DIR)/out_small REFNAME=chrY 	READSIM_REFNAME=chrY 	DEPTH=2
#	make eval_shmap ALLOUT_DIR=$(DIR)/out_small REFNAME=chm13 	READSIM_REFNAME=hg002 	DEPTH=1
#	make eval_shmap ALLOUT_DIR=$(DIR)/out_small REFNAME=chm13   READSIM_REFNAME=chm13   DEPTH=1
#	make eval_shmap ALLOUT_DIR=$(DIR)/out_small REFNAME=chm13   READS_PREFIX=HG002_small

datasets = {
    'refnames':         ['chrY', 'chm13', 'chm13'],
    'readsim_refnames': ['chrY', 'hg002', 'chm13'],
    'depths':           [     2,       1,       1],
#    'reads_prefixes': ['', '', 'HG002_small']
}    

include: "workflow/rules/prepare.smk"
include: "workflow/rules/run.smk"

rule all:
    input:
        expand("{outdir}/shmap/{refname}-reads{readsim_refname}-a{accuracy}-d{depth}-l{meanlen}/{params}/shmap.eval", 
               outdir=config["outdir"], 
               zip_=True,
               refname=datasets['refnames'],
               readsim_refname=datasets['readsim_refnames'],
               depth=datasets['depths'],
               accuracy=[config["accuracy"]]*len(datasets['refnames']),
               meanlen=[config["meanlen"]]*len(datasets['refnames']),
               params=[best_shmap_params]*len(datasets['refnames']))

rule some:
    input:
        expand("{outdir}/shmap/{refname}-reads{readsim_refname}-a{accuracy}-d{depth}-l{meanlen}/{params}/shmap.eval", 
               outdir=config["outdir"], 
#               reads_dir=config["reads_dir"],
               refname=config["refname"],
               readsim_refname=config["readsim_refname"],
               accuracy=config["accuracy"],
               depth=config["depth"],
               meanlen=config["meanlen"],
               params=best_shmap_params),
               
# Require robustness_eval for all {var} (e.g. k, r, t, d, o, m).
rule all_robustness:
    input:
        expand("{outdir}-robustness-{var}/{tool}/{refname}-reads{readsim_refname}-a{accuracy}-d{depth}-l{meanlen}/{params}/summary.eval",         
               outdir=config["outdir"],
               tool="shmap",
               refname=config["refname"],
               readsim_refname=config["readsim_refname"],
               accuracy=config["accuracy"],
               depth=config["depth"],
               meanlen=config["meanlen"],
               params=best_shmap_params,
               var=robustness_config["variations"].keys())
               